# EToKi环境部署超详细小白指南

## 🎯 这个指南适合谁？
- 完全不懂Linux的新手用户
- 需要在新服务器上部署EToKi的研究人员
- 想要快速复制工作环境的用户

## 📦 你会得到什么？
一个名为 `etoki_complete_YYYYMMDD_HHMMSS.tar.gz` 的文件，包含：
- 完整配置的EToKi环境
- 所有必需的软件依赖
- Kraken2数据库（用于质量控制）
- 自动安装脚本

## 🚀 零基础部署教程

### 第1步：准备工作

#### 1.1 检查服务器要求
在目标服务器上运行这些命令，确保满足基本要求：

```bash
# 检查操作系统（应该是Linux）
uname -a

# 检查可用磁盘空间（至少需要15GB）
df -h

# 检查内存（建议8GB以上）
free -h

# 检查conda是否已安装
conda --version
```

**重要提醒：**
- ✅ 如果看到conda版本号，说明conda已安装
- ❌ 如果提示"command not found"，需要先安装conda

#### 1.2 如果需要安装conda（仅当上一步失败时）
```bash
# 下载Miniconda（推荐）
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh

# 安装
bash Miniconda3-latest-Linux-x86_64.sh

# 重新启动终端或运行
source ~/.bashrc

# 验证安装
conda --version
```

### 第2步：上传和解压文件

#### 2.1 上传文件到服务器
使用以下任一方法将打包文件上传到服务器：

**方法A：使用scp（从本地电脑）**
```bash
scp etoki_complete_*.tar.gz username@server_ip:/home/username/
```

**方法B：使用wget（如果文件在网上）**
```bash
wget http://your-url/etoki_complete_*.tar.gz
```

**方法C：使用文件传输工具**
- WinSCP (Windows)
- FileZilla
- 或服务器提供的文件上传界面

#### 2.2 解压文件
```bash
# 进入存放文件的目录
cd /home/username/

# 解压文件（替换为实际文件名）
tar -xzf etoki_complete_*.tar.gz

# 进入解压后的目录
cd etoki_complete_*/
```

### 第3步：一键安装（推荐方法）

#### 3.1 运行自动安装脚本
```bash
# 确保脚本有执行权限
chmod +x install_etoki.sh

# 运行安装脚本
./install_etoki.sh
```

#### 3.2 观察安装过程
安装脚本会显示详细的进度信息：
```
=== EToKi环境安装程序 ===
开始时间: [时间]
✓ 检测到conda: conda 4.x.x
✓ Conda安装路径: /home/username/miniconda3
步骤1: 创建conda环境...
步骤2: 解压二进制文件...
步骤3: 安装kraken数据库...
步骤4: 验证安装...
✓ EToKi配置验证成功
=== 安装完成 ===
```

### 第4步：验证安装

#### 4.1 激活环境
```bash
conda activate etoki
```
**期望结果：** 命令提示符前面会出现 `(etoki)`

#### 4.2 检查配置
```bash
EToKi.py configure
```
**期望结果：** 看到一长串软件检查，最后显示 "Configuration complete."

#### 4.3 测试功能
```bash
# 查看EToKi帮助
EToKi.py --help

# 查看组装功能帮助
EToKi.py assemble --help
```

### 第5步：开始使用

#### 5.1 基本使用流程
每次使用前都需要激活环境：
```bash
conda activate etoki
```

#### 5.2 运行基因组组装
```bash
# 基本组装（不使用质控）
EToKi.py assemble --pe1 reads_1.fastq --pe2 reads_2.fastq -o output_folder

# 使用kraken质控的组装（推荐）
EToKi.py assemble --pe1 reads_1.fastq --pe2 reads_2.fastq --kraken -o output_folder
```

## 🆘 常见问题解决

### 问题1：conda命令不存在
**症状：** 运行conda时提示 "command not found"
**解决：** 重新初始化conda
```bash
source ~/miniconda3/etc/profile.d/conda.sh
conda init bash
source ~/.bashrc
```

### 问题2：权限错误
**症状：** 提示 "Permission denied"
**解决：** 修复权限
```bash
chmod -R 755 ~/miniconda3/envs/etoki/
```

### 问题3：磁盘空间不足
**症状：** 安装过程中提示空间不足
**解决：** 
```bash
# 检查空间使用
df -h
# 清理不必要的文件或选择其他目录
```

### 问题4：Java错误
**症状：** pilon相关错误
**解决：** 重新安装Java
```bash
conda activate etoki
conda install openjdk=11 -y
```

### 问题5：网络连接问题
**症状：** conda创建环境时下载失败
**解决：** 
```bash
# 使用国内镜像源
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/
```

## 💡 使用技巧

### 技巧1：创建快捷启动脚本
```bash
# 创建启动脚本
cat > ~/start_etoki.sh << 'EOF'
#!/bin/bash
source ~/miniconda3/etc/profile.d/conda.sh
conda activate etoki
echo "EToKi环境已激活，当前版本："
EToKi.py --version
EOF

chmod +x ~/start_etoki.sh

# 使用方法
~/start_etoki.sh
```

### 技巧2：设置环境别名
在 `~/.bashrc` 文件末尾添加：
```bash
alias etoki='conda activate etoki'
alias etoki-check='conda activate etoki && EToKi.py configure'
```

### 技巧3：批量处理脚本模板
```bash
#!/bin/bash
# 批量处理多个样本

# 激活环境
conda activate etoki

# 设置输入和输出目录
INPUT_DIR="/path/to/fastq/files"
OUTPUT_DIR="/path/to/results"

# 批量处理
for file1 in ${INPUT_DIR}/*_1.fastq; do
    file2=${file1/_1.fastq/_2.fastq}
    sample=$(basename $file1 _1.fastq)
    
    echo "处理样本: $sample"
    EToKi.py assemble --pe1 $file1 --pe2 $file2 --kraken -o ${OUTPUT_DIR}/${sample}
done
```

## 📋 完整的命令清单

### 环境管理
```bash
# 激活环境
conda activate etoki

# 退出环境
conda deactivate

# 查看所有环境
conda env list

# 删除环境（如果需要重装）
conda env remove -n etoki
```

### EToKi命令
```bash
# 查看版本
EToKi.py --version

# 检查配置
EToKi.py configure

# 基本组装
EToKi.py assemble --pe1 R1.fastq --pe2 R2.fastq -o output

# 高级组装（使用所有功能）
EToKi.py assemble --pe1 R1.fastq --pe2 R2.fastq --kraken --minLen 500 --maxMem 32 -o output

# MLST分析
EToKi.py MLSType -i genome.fasta -o mlst_output

# 系统进化分析
EToKi.py phylo -t tree_input -o phylo_output
```

## 🎓 学习资源

### 官方文档
- EToKi GitHub: https://github.com/zheminzhou/EToKi
- Conda用户指南: https://docs.conda.io/projects/conda/en/latest/user-guide/

### 推荐阅读
- 基因组组装基础知识
- MLST系统发育分析
- 微生物基因组学入门

## 🏁 总结

恭喜！如果您按照本指南操作到这里，您已经成功：
1. ✅ 在新服务器上部署了完整的EToKi环境
2. ✅ 验证了所有组件正常工作
3. ✅ 掌握了基本的使用方法

现在您可以开始进行基因组组装和分析工作了！

**记住最重要的三个命令：**
1. `conda activate etoki` - 激活环境
2. `EToKi.py configure` - 检查配置
3. `EToKi.py assemble --help` - 查看帮助

祝您科研工作顺利！🧬🔬
