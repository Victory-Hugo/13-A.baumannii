# EToKi环境打包技术文档（管理员版）

## 🔧 打包原理和架构

### 打包组件说明
1. **环境配置文件** (`etoki_environment.yml`)
   - 记录所有conda包及版本信息
   - 用于重建基础环境结构

2. **二进制文件包** (`etoki_env_binaries.tar.gz`)
   - 包含完整的编译好的二进制文件
   - 避免在目标机器上重新编译
   - 大小约2-3GB

3. **数据库文件** (`kraken_database.tar.gz`)
   - Kraken2 minikraken数据库
   - 大小约8GB（压缩后约5.6GB）
   - 包含完整的分类学数据

4. **自动化脚本** (`install_etoki.sh`)
   - 自动检测系统环境
   - 自动化安装流程
   - 错误处理和日志记录

## 📁 打包文件结构

```
etoki_complete_YYYYMMDD_HHMMSS/
├── etoki_environment.yml              # conda环境配置
├── etoki_env_binaries.tar.gz         # 二进制文件包
├── kraken_database.tar.gz             # kraken数据库
├── install_etoki.sh                   # 自动安装脚本
├── README_安装使用指南.md             # 详细使用说明
├── package_info.txt                   # 打包元信息
└── 小白用户部署指南.md               # 简化版用户指南
```

## 🚀 高级部署选项

### 选项1：完整自动化部署
```bash
# 解压并自动安装
tar -xzf etoki_complete_*.tar.gz
cd etoki_complete_*/
./install_etoki.sh
```

### 选项2：分步手动部署
```bash
# 1. 创建基础环境
conda env create -f etoki_environment.yml

# 2. 手动解压二进制文件
CONDA_BASE=$(conda info --base)
tar -xzf etoki_env_binaries.tar.gz -C "${CONDA_BASE}/envs/"

# 3. 配置数据库
mkdir -p "${CONDA_BASE}/envs/etoki/share/etoki-1.2.3/externals/minikraken2"
tar -xzf kraken_database.tar.gz -C "${CONDA_BASE}/envs/etoki/share/etoki-1.2.3/externals/minikraken2"

# 4. 验证配置
conda activate etoki
EToKi.py configure
```

### 选项3：网络化部署
```bash
# 仅安装基础环境，数据库使用网络下载
conda env create -f etoki_environment.yml
conda activate etoki
EToKi.py configure --download_krakenDB
```

## 🔍 系统兼容性矩阵

| 操作系统 | 版本要求 | 测试状态 | 备注 |
|---------|----------|----------|------|
| Ubuntu | 18.04+ | ✅ 完全支持 | 推荐平台 |
| CentOS | 7.0+ | ✅ 完全支持 | 企业级支持 |
| RHEL | 7.0+ | ✅ 完全支持 | 企业级支持 |
| Debian | 9.0+ | ⚠️ 基本支持 | 需验证glibc版本 |
| Alpine | 3.10+ | ❌ 不支持 | musl libc不兼容 |

### 依赖要求详细说明
```bash
# 最小系统要求检查脚本
#!/bin/bash

# 检查glibc版本（关键）
ldd --version | head -1

# 检查Python兼容性
python3 --version

# 检查必要的系统库
ldconfig -p | grep -E "(libz|libssl|libcrypto)"

# 检查Java环境（可选，会自动安装）
java -version 2>&1 || echo "Java will be installed"
```

## 🛠 故障排除高级指南

### 问题诊断脚本
```bash
#!/bin/bash
# 环境诊断脚本

echo "=== EToKi环境诊断报告 ==="
echo "时间: $(date)"
echo "主机: $(hostname)"
echo "用户: $(whoami)"
echo ""

echo "1. 系统信息:"
uname -a
echo "发行版: $(cat /etc/os-release | grep PRETTY_NAME)"
echo ""

echo "2. 磁盘空间:"
df -h | grep -E "(/$|/home|/tmp)"
echo ""

echo "3. 内存信息:"
free -h
echo ""

echo "4. Conda环境:"
conda --version 2>&1 || echo "Conda未安装"
conda info --base 2>&1 || echo "无法获取conda路径"
echo ""

echo "5. EToKi环境检查:"
if conda env list | grep -q etoki; then
    echo "✓ etoki环境存在"
    conda activate etoki
    EToKi.py configure 2>&1 | tail -5
else
    echo "✗ etoki环境不存在"
fi
echo ""

echo "6. 关键文件检查:"
CONDA_BASE=$(conda info --base 2>/dev/null)
if [ ! -z "$CONDA_BASE" ]; then
    echo "Conda路径: $CONDA_BASE"
    echo "EToKi路径: $CONDA_BASE/envs/etoki/bin/EToKi.py"
    [ -f "$CONDA_BASE/envs/etoki/bin/EToKi.py" ] && echo "✓ EToKi可执行文件存在" || echo "✗ EToKi可执行文件缺失"
    
    KRAKEN_PATH="$CONDA_BASE/envs/etoki/share/etoki-1.2.3/externals/minikraken2"
    [ -d "$KRAKEN_PATH" ] && echo "✓ Kraken数据库目录存在" || echo "✗ Kraken数据库目录缺失"
    
    if [ -d "$KRAKEN_PATH" ]; then
        echo "数据库文件数量: $(ls -1 $KRAKEN_PATH/ 2>/dev/null | wc -l)"
        echo "数据库大小: $(du -sh $KRAKEN_PATH 2>/dev/null | cut -f1)"
    fi
fi

echo ""
echo "=== 诊断完成 ==="
```

### 常见错误解决方案

#### 错误1：glibc版本不兼容
```bash
# 症状: /lib64/libc.so.6: version `GLIBC_2.XX' not found
# 解决: 使用conda安装glibc兼容层
conda activate etoki
conda install gxx_linux-64 gcc_linux-64
```

#### 错误2：权限问题
```bash
# 症状: Permission denied访问conda目录
# 解决: 修复权限和所有权
sudo chown -R $(whoami):$(whoami) ~/miniconda3/
chmod -R 755 ~/miniconda3/envs/etoki/
```

#### 错误3：磁盘空间问题
```bash
# 症状: No space left on device
# 解决1: 清理conda缓存
conda clean --all -y

# 解决2: 移动环境到其他分区
CONDA_BASE=$(conda info --base)
mkdir -p /other/partition/envs
mv $CONDA_BASE/envs/etoki /other/partition/envs/
ln -s /other/partition/envs/etoki $CONDA_BASE/envs/etoki
```

#### 错误4：网络连接问题
```bash
# 症状: CondaHTTPError连接失败
# 解决: 配置代理和镜像源
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/bioconda/

# 如果有代理
conda config --set proxy_servers.http http://proxy.example.com:8080
conda config --set proxy_servers.https https://proxy.example.com:8080
```

## 📊 性能优化建议

### 内存优化
```bash
# 大内存系统优化（32GB+）
export OMP_NUM_THREADS=16
export MALLOC_ARENA_MAX=4

# 小内存系统优化（8GB）
export OMP_NUM_THREADS=4
export MALLOC_ARENA_MAX=2
```

### 存储优化
```bash
# 使用SSD加速临时文件
export TMPDIR=/path/to/ssd/tmp

# 并行I/O优化
export PIGZ_THREADS=8  # 加速压缩解压
```

### 网络优化
```bash
# 加速conda包下载
conda config --set remote_read_timeout_secs 120
conda config --set remote_connect_timeout_secs 30
```

## 🔒 安全考虑

### 文件权限设置
```bash
# 设置安全的环境权限
chmod 755 $(conda info --base)/envs/etoki/
chmod -R 644 $(conda info --base)/envs/etoki/share/
chmod -R 755 $(conda info --base)/envs/etoki/bin/
```

### 数据完整性验证
```bash
# 生成校验和
find $(conda info --base)/envs/etoki/share/etoki-1.2.3/externals/minikraken2/ -type f -exec sha256sum {} \; > kraken_checksums.txt

# 验证校验和
sha256sum -c kraken_checksums.txt
```

## 📈 监控和维护

### 环境健康检查脚本
```bash
#!/bin/bash
# 定期运行的健康检查

LOG_FILE="/var/log/etoki_health.log"
DATE=$(date)

{
    echo "[$DATE] 开始健康检查"
    
    # 检查环境可用性
    conda activate etoki
    if EToKi.py configure >/dev/null 2>&1; then
        echo "[$DATE] ✓ EToKi配置正常"
    else
        echo "[$DATE] ✗ EToKi配置异常"
    fi
    
    # 检查磁盘空间
    DISK_USAGE=$(df $(conda info --base) | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ $DISK_USAGE -lt 90 ]; then
        echo "[$DATE] ✓ 磁盘空间充足 ($DISK_USAGE%)"
    else
        echo "[$DATE] ⚠ 磁盘空间不足 ($DISK_USAGE%)"
    fi
    
    echo "[$DATE] 健康检查完成"
    echo ""
} >> $LOG_FILE
```

### 自动更新脚本
```bash
#!/bin/bash
# conda环境更新脚本

conda activate etoki
conda update --all -y
conda clean --all -y

# 记录更新日志
echo "$(date): 环境更新完成" >> /var/log/etoki_updates.log
```

## 📋 部署清单

### 部署前检查
- [ ] 目标系统满足最低要求
- [ ] 有足够磁盘空间（15GB+）
- [ ] 网络连接正常
- [ ] 用户有适当权限
- [ ] 备份现有环境（如果有）

### 部署步骤
- [ ] 上传打包文件
- [ ] 验证文件完整性
- [ ] 运行安装脚本
- [ ] 验证配置
- [ ] 运行测试任务
- [ ] 生成部署报告

### 部署后验证
- [ ] 所有组件正常加载
- [ ] 数据库访问正常
- [ ] 示例任务运行成功
- [ ] 性能基准测试通过
- [ ] 用户培训完成

## 📚 相关资源

### 官方文档
- [EToKi GitHub](https://github.com/zheminzhou/EToKi)
- [Conda Documentation](https://docs.conda.io/)
- [Kraken2 Manual](https://ccb.jhu.edu/software/kraken2/)

### 社区支持
- [Biostars EToKi相关问题](https://www.biostars.org/t/etoki/)
- [Galaxy Project EToKi工具](https://usegalaxy.org/)

## 📞 技术支持联系方式

如需技术支持，请提供以下信息：
1. 系统诊断脚本输出
2. 错误日志文件
3. 系统环境信息
4. 具体错误描述

---
*本文档最后更新：2025年8月28日*
